{% extends 'teacher_page/gv_base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/teacher/cham_diem.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ title }}</h1>
    
    <div class="assignment-info">
        <h2>{{ bai_tap.tieu_de }}</h2>
        <div class="info-grid">
            <div class="info-item">
                <label>Lo·∫°i b√†i t·∫≠p:</label>
                <span class="assignment-type {% if bai_tap.loai_baitap == 'code' %}code{% else %}quiz{% endif %}">
                    {% if bai_tap.loai_baitap == 'code' %}L·∫≠p tr√¨nh{% else %}Tr·∫Øc nghi·ªám{% endif %}
                </span>
            </div>
            <div class="info-item">
                <label>H·∫°n n·ªôp:</label>
                <span>{{ bai_tap.han_nop|date:"d/m/Y H:i" }}</span>
            </div>
            <div class="info-item">
                <label>T·ªïng s·ªë b√†i n·ªôp:</label>
                <span>{{ bai_lam_list|length }}</span>
            </div>
        </div>
    </div>
    
    <div class="submissions-list">
        <h3>Danh s√°ch b√†i l√†m</h3>
        
        {% if bai_lam_list %}
        <div class="table-responsive">
            <table class="submissions-table">
                <thead>
                    <tr>
                        <th>Sinh vi√™n</th>
                        <th>Th·ªùi gian n·ªôp</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>ƒêi·ªÉm s·ªë</th>
                        <th>File n·ªôp</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bai_lam in bai_lam_list %}
                    <tr>
                        <td>
                            <div class="student-info">
                                <strong>{{ bai_lam.sinh_vien.get_full_name|default:bai_lam.sinh_vien.username }}</strong>
                                <small>{{ bai_lam.sinh_vien.email }}</small>
                            </div>
                        </td>
                        <td>{{ bai_lam.thoi_gian_nop|date:"d/m/Y H:i" }}</td>
                        <td>
                            <span class="status {% if bai_lam.da_cham %}graded{% else %}pending{% endif %}">
                                {% if bai_lam.da_cham %}ƒê√£ ch·∫•m{% else %}Ch∆∞a ch·∫•m{% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="score">
                                {% if bai_lam.da_cham %}
                                    <strong>{{ bai_lam.diem_so|floatformat:1 }}/10</strong>
                                    {% if bai_tap.loai_baitap == 'code' and bai_lam.so_test_pass is not None %}
                                        <br><small class="test-stats">
                                            <span class="test-summary">
                                                <span class="pass-count">{{ bai_lam.so_test_pass }}</span>/<span class="total-count">{{ bai_lam.tong_so_test }}</span> test cases
                                            </span>
                                            {% if bai_lam.ket_qua_test %}
                                                <br>
                                                {% for test in bai_lam.ket_qua_test %}
                                                    {% if test.ket_qua == 'PASS' %}
                                                        <span class="test-pass" title="{{ test.ten_test }}">‚úì</span>
                                                    {% elif test.ket_qua == 'FAIL' %}
                                                        <span class="test-fail" title="{{ test.ten_test }}">‚úó</span>
                                                    {% else %}
                                                        <span class="test-error" title="{{ test.ten_test }}">‚ö†</span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </small>
                                    {% elif bai_tap.loai_baitap == 'quiz' and bai_lam.so_cau_dung is not None %}
                                        <br><small class="quiz-stats">
                                            <span class="quiz-summary">
                                                <span class="correct-count">{{ bai_lam.so_cau_dung }}</span>/<span class="total-questions">{{ bai_lam.tong_so_cau }}</span> c√¢u ƒë√∫ng
                                            </span>
                                        </small>
                                    {% endif %}
                                    {% if bai_lam.nhan_xet %}
                                        <br><small class="comment-preview" title="{{ bai_lam.nhan_xet }}">
                                            üí¨ <em>{{ bai_lam.nhan_xet|truncatechars:50 }}</em>
                                        </small>
                                    {% endif %}
                                {% else %}
                                    <span class="no-score">--</span>
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if bai_lam.file_nop %}
                                <a href="{% url 'download_file' bai_lam.id %}" class="btn btn-sm btn-outline-primary" title="T·∫£i xu·ªëng file">
                                    {% if bai_lam.file_name|slice:"-3:" == ".py" %}
                                    {% elif bai_lam.file_name|slice:"-4:" == ".zip" %}
                                    {% elif bai_lam.file_name|slice:"-4:" == ".rar" %}
                                    {% elif bai_lam.file_name|slice:"-4:" == ".pdf" %}
                                    {% elif bai_lam.file_name|slice:"-4:" == ".doc" or bai_lam.file_name|slice:"-5:" == ".docx" %}
                                    {% else %}
                                    {% endif %} {{ bai_lam.file_name }}
                                </a>
                            {% else %}
                                <span class="text-muted">Kh√¥ng c√≥ file</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if bai_tap.loai_baitap == 'quiz' %}
                                    <button class="btn btn-sm btn-primary action-btn" onclick="chamBaiTracNghiem({{ bai_lam.id }})">
                                        {% if bai_lam.da_cham %}Ch·∫•m l·∫°i{% else %}Ch·∫•m ƒëi·ªÉm{% endif %}
                                    </button>
                                {% else %}
                                    <button class="btn btn-sm btn-primary action-btn" onclick="chamBaiLapTrinh({{ bai_lam.id }})">
                                        {% if bai_lam.da_cham %}Ch·∫•m l·∫°i{% else %}Ch·∫•m ƒëi·ªÉm{% endif %}
                                    </button>
                                {% endif %}
                                <button class="btn btn-sm btn-warning action-btn" onclick="nhapDiem({{ bai_lam.id }}, '{{ bai_lam.diem_so|default:0 }}', '{{ bai_lam.nhan_xet|default:""|escapejs }}')">
                                    Nh·∫≠p ƒëi·ªÉm
                                </button>
                                <a href="{% url 'ket_qua_cham_diem' bai_lam.id %}" class="btn btn-sm btn-info action-btn">
                                    K·∫øt qu·∫£
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>Ch∆∞a c√≥ sinh vi√™n n√†o n·ªôp b√†i.</p>
        </div>
        {% endif %}
    </div>
    
    <div class="back-actions">
        <a href="{% url 'cham_diem' %}" class="btn btn-back">‚Üê Quay l·∫°i</a>
    </div>
</div>

<!-- Modal k·∫øt qu·∫£ test -->
<div id="testResultModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>K·∫øt qu·∫£ ch·∫•m b√†i</h3>
            <span class="close" onclick="closeTestResultModal()">&times;</span>
        </div>
        <div class="modal-body" id="testResultBody">
            <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
        </div>
    </div>
</div>

<!-- Modal nh·∫≠p ƒëi·ªÉm -->
<div id="scoreModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Nh·∫≠p ƒëi·ªÉm th·ªß c√¥ng</h3>
            <span class="close" onclick="closeScoreModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="scoreForm">
                <div class="form-group">
                    <label for="scoreInput">ƒêi·ªÉm s·ªë (0-10):</label>
                    <input type="number" id="scoreInput" min="0" max="10" step="0.1" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="commentInput">Nh·∫≠n x√©t (t√πy ch·ªçn):</label>
                    <textarea id="commentInput" class="form-control" rows="3" placeholder="Nh·∫≠p nh·∫≠n x√©t cho sinh vi√™n..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">L∆∞u ƒëi·ªÉm</button>
                    <button type="button" class="btn btn-secondary" onclick="closeScoreModal()">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function chamBaiTracNghiem(baiLamId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ch·∫•m b√†i n√†y?')) {
            fetch(`/cham-bai-trac-nghiem/${baiLamId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Ch·∫•m ƒëi·ªÉm th√†nh c√¥ng!\nƒêi·ªÉm: ${data.diem_so}/10\nS·ªë c√¢u ƒë√∫ng: ${data.so_cau_dung}/${data.tong_so_cau}`);
                    location.reload();
                } else {
                    alert('L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi ch·∫•m b√†i!');
            });
        }
    }
    
    function chamBaiLapTrinh(baiLamId) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ch·∫•m b√†i n√†y?')) {
            const loading = document.createElement('div');
            loading.innerHTML = 'ƒêang ch·∫•m b√†i...';
            loading.className = 'loading';
            document.body.appendChild(loading);
            
            fetch(`/cham-bai-lap-trinh/${baiLamId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.body.removeChild(loading);
                if (data.success) {
                    showTestResults(data);
                    location.reload();
                } else {
                    alert('L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                document.body.removeChild(loading);
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi ch·∫•m b√†i!');
            });
        }
    }
    
    function showTestResults(data) {
        let resultHtml = `
            <h4>K·∫øt qu·∫£ ch·∫•m b√†i</h4>
            <p><strong>ƒêi·ªÉm s·ªë:</strong> ${data.diem_so}/10</p>
            <p><strong>ƒêi·ªÉm test:</strong> ${data.tong_diem}/${data.diem_toi_da}</p>
            <div class="test-results">
        `;
        
        data.ket_qua_test.forEach(test => {
            resultHtml += `
                <div class="test-case ${test.ket_qua.toLowerCase()}">
                    <h5>${test.ten_test} - ${test.ket_qua}</h5>
                    <p><strong>ƒêi·ªÉm:</strong> ${test.diem_dat}/${test.diem_toi_da}</p>
                    ${test.error ? `<p class="error">L·ªói: ${test.error}</p>` : ''}
                </div>
            `;
        });
        
        resultHtml += '</div>';
        
        document.getElementById('testResultBody').innerHTML = resultHtml;
        document.getElementById('testResultModal').style.display = 'block';
    }
    
    function closeTestResultModal() {
        document.getElementById('testResultModal').style.display = 'none';
    }
    
    // Functions cho modal nh·∫≠p ƒëi·ªÉm
    let currentBaiLamId = null;
    
    function nhapDiem(baiLamId, currentScore, currentComment) {
        currentBaiLamId = baiLamId;
        document.getElementById('scoreInput').value = currentScore || '';
        document.getElementById('commentInput').value = currentComment || '';
        document.getElementById('scoreModal').style.display = 'block';
    }
    
    function closeScoreModal() {
        document.getElementById('scoreModal').style.display = 'none';
        currentBaiLamId = null;
    }
    
    // X·ª≠ l√Ω submit form nh·∫≠p ƒëi·ªÉm
    document.getElementById('scoreForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const score = parseFloat(document.getElementById('scoreInput').value);
        const comment = document.getElementById('commentInput').value;
        
        if (score < 0 || score > 10) {
            alert('ƒêi·ªÉm ph·∫£i t·ª´ 0 ƒë·∫øn 10!');
            return;
        }
        
        if (!currentBaiLamId) {
            alert('L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c b√†i l√†m!');
            return;
        }
        
        // G·ª≠i request c·∫≠p nh·∫≠t ƒëi·ªÉm
        fetch(`/sua-diem/${currentBaiLamId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                diem_so: score,
                nhan_xet: comment 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`ƒê√£ c·∫≠p nh·∫≠t ƒëi·ªÉm th√†nh c√¥ng: ${score}/10`);
                closeScoreModal();
                location.reload();
            } else {
                alert('L·ªói: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t ƒëi·ªÉm!');
        });
    });
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
