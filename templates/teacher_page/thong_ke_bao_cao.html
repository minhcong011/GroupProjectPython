{% extends 'teacher_page/gv_base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/thong_ke_bao_cao.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="stats-container">
    <!-- Header -->
    <div class="header-stats">
        <h1> {{ title }}</h1>
        <p>T·ªïng quan v√† ph√¢n t√≠ch chi ti·∫øt v·ªÅ ti·∫øn ƒë·ªô h·ªçc t·∫≠p c·ªßa sinh vi√™n</p>
    </div>

    <!-- Export Buttons -->
    <div class="export-section">
        <a href="{% url 'export_excel' %}" class="btn btn-success">
             Xu·∫•t Excel
        </a>
        <a href="{% url 'export_pdf' %}" class="btn btn-primary">
             Xu·∫•t PDF
        </a>
        <a href="{% url 'assignment_list' %}" class="btn btn-secondary">
            ‚Üê Quay l·∫°i
        </a>
    </div>

    <!-- Overview Cards -->
    <div class="overview-cards">
        <div class="card">
            <h3>T·ªïng s·ªë b√†i t·∫≠p</h3>
            <p class="number">{{ tong_bai_tap }}</p>
            <p class="description">B√†i t·∫≠p ƒë√£ t·∫°o</p>
        </div>
        
        <div class="card">
            <h3>T·ªïng b√†i n·ªôp</h3>
            <p class="number">{{ tong_bai_nop }}</p>
            <p class="description">B√†i l√†m ƒë√£ nh·∫≠n</p>
        </div>
        
        <div class="card">
            <h3>ƒê√£ ch·∫•m ƒëi·ªÉm</h3>
            <p class="number">{{ bai_da_cham }}</p>
            <p class="description">B√†i l√†m ƒë√£ ho√†n th√†nh</p>
        </div>
        
        <div class="card">
            <h3>ƒêi·ªÉm trung b√¨nh</h3>
            <p class="number">{{ diem_trung_binh }}/10</p>
            <p class="description">ƒêi·ªÉm TB to√†n kh√≥a</p>
        </div>
    </div>

    <!-- Monthly Chart -->
    <div class="chart-section">
        <h3> Th·ªëng k√™ b√†i n·ªôp theo th√°ng</h3>
        <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <!-- Assignment Statistics -->
    <div class="table-section">
        <h3> Chi ti·∫øt theo b√†i t·∫≠p</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>T√™n b√†i t·∫≠p</th>
                        <th>Lo·∫°i</th>
                        <th>T·ªïng n·ªôp</th>
                        <th>ƒê√£ ch·∫•m</th>
                        <th>Ti·∫øn ƒë·ªô</th>
                        <th>ƒêi·ªÉm TB</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in bai_tap_stats %}
                    <tr>
                        <td><strong>{{ stat.bai_tap.tieu_de }}</strong></td>
                        <td>
                            <span class="badge {% if stat.bai_tap.loai_baitap == 'code' %}badge-info{% else %}badge-warning{% endif %}">
                                {% if stat.bai_tap.loai_baitap == 'code' %}L·∫≠p tr√¨nh{% else %}Tr·∫Øc nghi·ªám{% endif %}
                            </span>
                        </td>
                        <td>{{ stat.tong_nop }}</td>
                        <td>{{ stat.da_cham }}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ stat.ti_le_hoan_thanh }}%"></div>
                            </div>
                            <small>{{ stat.ti_le_hoan_thanh }}%</small>
                        </td>
                        <td>
                            {% if stat.diem_tb > 0 %}
                                <strong>{{ stat.diem_tb }}/10</strong>
                            {% else %}
                                <span style="color: #999;">--</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.chua_cham > 0 %}
                                <span class="badge badge-warning">{{ stat.chua_cham }} ch∆∞a ch·∫•m</span>
                            {% else %}
                                <span class="badge badge-success">Ho√†n th√†nh</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align: center; color: #999; padding: 2rem;">
                            Ch∆∞a c√≥ b√†i t·∫≠p n√†o ƒë∆∞·ª£c t·∫°o
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Student Performance -->
    <div class="table-section">
        <h3>üë• Th√†nh t√≠ch sinh vi√™n</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Sinh vi√™n</th>
                        <th>T·ªïng b√†i n·ªôp</th>
                        <th>ƒê√£ ch·∫•m</th>
                        <th>ƒêi·ªÉm trung b√¨nh</th>
                        <th>X·∫øp h·∫°ng</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in sinh_vien_stats %}
                    <tr>
                        <td>
                            <strong>
                                {% if stat.sinh_vien__first_name %}
                                    {{ stat.sinh_vien__first_name }} {{ stat.sinh_vien__last_name }}
                                {% else %}
                                    {{ stat.sinh_vien__username }}
                                {% endif %}
                            </strong>
                        </td>
                        <td>{{ stat.tong_bai_nop }}</td>
                        <td>{{ stat.bai_da_cham }}</td>
                        <td>
                            {% if stat.diem_tb %}
                                <strong>{{ stat.diem_tb|floatformat:1 }}/10</strong>
                            {% else %}
                                <span style="color: #999;">--</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if stat.diem_tb %}
                                {% if stat.diem_tb >= 8 %}
                                    <span class="badge badge-success">Xu·∫•t s·∫Øc</span>
                                {% elif stat.diem_tb >= 6.5 %}
                                    <span class="badge badge-info">Kh√°</span>
                                {% elif stat.diem_tb >= 5 %}
                                    <span class="badge badge-warning">Trung b√¨nh</span>
                                {% else %}
                                    <span class="badge" style="background: #ffebee; color: #c62828;">C·∫ßn c·∫£i thi·ªán</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #999;">--</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999; padding: 2rem;">
                            Ch∆∞a c√≥ sinh vi√™n n√†o n·ªôp b√†i
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>

const ctx = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
            {% for stat in monthly_stats %}
                '{{ stat.month|date:"m/Y" }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'S·ªë b√†i n·ªôp',
            data: [
                {% for stat in monthly_stats %}
                    {{ stat.count }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#1976d2',
            backgroundColor: 'rgba(25, 118, 210, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'ƒêi·ªÉm trung b√¨nh',
            data: [
                {% for stat in monthly_stats %}
                    {{ stat.avg_score|default:0 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: '#4caf50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: 'Xu h∆∞·ªõng n·ªôp b√†i v√† ƒëi·ªÉm s·ªë trong 6 th√°ng g·∫ßn nh·∫•t'
            }
        },
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'S·ªë b√†i n·ªôp'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'ƒêi·ªÉm trung b√¨nh'
                },
                min: 0,
                max: 10,
                grid: {
                    drawOnChartArea: false,
                },
            }
        }
    }
});
</script>
{% endblock %}
